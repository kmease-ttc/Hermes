Replit Prompt: Add “Fix Plan” Action List + Rename “Create PR” → “Fix It” (Socrates-guided, Safe, Not Too Frequent)

Goal
On Speedster (and eventually all crew pages), before we run an automated fix (GitHub PR), the UI must show a concrete, reviewable “Fix Plan” list:

* what we’re going to change
* why
* expected outcome
* risk level / safety constraints
  Then the user clicks “Fix It” to generate the PR.

This plan must be generated by combining:

* Speedster evidence (current vitals + opportunities)
* Socrates (Knowledge Base) history + best practices for this site
  And it must enforce safety (don’t change too frequently, keep changes small).

Scope (Phase 1)

* Implement on Speedster page first.
* Make the architecture reusable so other crew pages can adopt it.

UI Changes (Speedster)

1. Rename the primary button

* Change button label from “Create Fix PR” / “Create PR” → “Fix It”
* Keep secondary buttons: “Run Vitals Scan” and “Export Fix Pack”

2. Add a “Fix Plan” section near the top (before the button)
   Place within/under the Core Web Vitals Overview card:

* Section title: “Fix Plan”
* Subtitle: “Proposed changes based on current vitals + past learnings”
* State handling:

  * Loading: “Generating plan…”
  * Empty: “No recommended fixes right now”
  * Blocked: show what’s missing (KB keys, GitHub config, etc.)

Fix Plan list format (each item)
Each plan item must show:

* Title (short)
* Why (1 line)
* Proposed change (what we’ll modify)
* Expected outcome (e.g., “Reduce LCP by ~0.5–1.5s”)
* Risk (Low/Med/High)
* Confidence (Low/Med/High)
* Source tags (Speedster + Socrates)

3. Add a small “Safety” summary strip next to the Fix It button
   Show:

* Max changes this cycle (editable)
* Cooldown / frequency guard (“Last fix PR: X days ago”)
* Tooltip: “Recommended to limit changes per cycle and avoid frequent releases to reduce ranking volatility.”

Behavior / Data Flow

4. Add two backend endpoints (plan + execute)

A) Generate fix plan (preview)
POST /api/fix-plan/speedster
Body:
{
siteId,
currentMetrics: { vitals.lcp, vitals.cls, vitals.inp, performanceScore, ... },
context: { topUrls, opportunities, lastRunId }
}

Server steps:

1. Pull latest Speedster evidence from DB (last-known snapshot)
2. Query Socrates (Knowledge Base) for:

   * prior fixes on performance (topic=core_web_vitals)
   * what worked/failed
   * site-specific playbooks
   * recent fix frequency (last PR timestamps)
3. Produce a structured Fix Plan:
   {
   planId,
   generatedAt,
   cooldown: { allowed: true/false, nextAllowedAt, reason },
   maxChangesRecommended: number,
   items: [
   {
   id,
   title,
   why,
   proposedChanges: [{ type, fileHint, description }],
   expectedOutcome,
   risk,
   confidence,
   sources: ["speedster", "socrates"]
   }
   ]
   }

Store plan in DB (and write a KB entry noting the plan was generated).

B) Execute fix plan (create PR)
POST /api/fix-plan/execute
Body:
{ siteId, planId, maxChanges, mode: "pr_only" }

Server steps:

1. Re-load plan from DB (do not regenerate silently)

2. Enforce safety gates:

   * cooldown check (block if too soon unless user overrides with reason)
   * maxChanges clamp

3. Call Change Worker (GitHub PR workflow) with:

   * plan items (bounded by maxChanges)
   * repo + branch naming
   * PR title/body includes the Fix Plan summary

4. Write results back to Socrates:

   * PR URL
   * plan items executed
   * timestamps and run ids

5. Frontend state
   On Speedster page load:

* Automatically call /api/fix-plan/speedster and render the list.
* Cache the plan for quick reload (show last plan instantly, then refresh).
* “Fix It” button is disabled unless:

  * plan has at least 1 item
  * cooldown allows OR user confirms override
  * GitHub + Socrates config present

Safety + Best Practices (must-have)
6) Cooldown + frequency controls
Implement:

* Default cooldown: 3–7 days between automated PRs per site per topic (core_web_vitals)
* Use Socrates history to determine last PR time for this topic.
* Show “Last fix PR: …” and “Next recommended: …”
* Allow override only via a confirmation modal with a reason.

7. Change limits per cycle

* Default maxChanges: 5–20 (configurable)
* Plan generator should recommend a number based on site size and issue severity.
* Execute endpoint must enforce the max.

Acceptance criteria

* Speedster shows a real Fix Plan list before any PR is created.
* Clicking “Fix It” creates a PR using that plan (or blocks with clear reasons).
* The workflow consults Socrates and writes back outcomes.
* Cooldown prevents overly frequent changes by default.
* The same pattern is reusable for other crew pages.

Phase 2 (later)

* Generalize Fix Plan generator for all crew pages:
  POST /api/fix-plan/generate?crewId=...
  POST /api/fix-plan/execute
