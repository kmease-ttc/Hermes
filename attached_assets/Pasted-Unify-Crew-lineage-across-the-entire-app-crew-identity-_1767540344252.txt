Unify Crew “lineage” across the entire app: crew identity, color/theme, integrations/dependencies, and score must come from one canonical source and be consumed consistently on every page (dashboard, crew pages, settings, widgets). Fix current mismatch: Lookout score 58 on crew page vs 51 on dashboard.

Problem (what’s happening)

* Different pages are computing/formatting crew score independently (dashboard vs crew page), so they drift (Lookout 51 vs 58).
* Crew color/theme is applied in some places (dashboard card) but missing in others (crew page), indicating theme is not a first-class shared token.
* Integrations and “who owns what” (e.g., Popular owns GA4) are not encoded as canonical dependency metadata, so CTAs and empty states differ per page.

Goal
Create a single “CrewRegistry” + “CrewStatus service” so:

* Every crew has a canonical ID, name, color theme, and dependency graph
* Every site has a canonical per-crew status: score, missions, primary KPI, readiness, last run
* Every page reads from the same API/model for crew status and theme tokens
* No page implements its own score math, crew color, or integration ownership

1. CrewRegistry (single source of truth)
   Create shared/crew/registry.ts

CrewId enum:
natasha, lookout, popular, scotty, speedster, sentinel, hemingway, beacon, atlas, draper, socrates

CrewDefinition:
{
id: CrewId
name: string
shortDesc: string
theme: {
primary: string
ring: string
bgSubtle: string
text: string
badge: string
}
primaryMetricId: string
dependencies: {
required: IntegrationId[]
optional: IntegrationId[]
}
ownedIntegrations: IntegrationId[]   // e.g. Popular owns ga4 + gsc auth
}

Export:

* crewRegistry: Record<CrewId, CrewDefinition>
* getCrew(id): CrewDefinition

2. IntegrationRegistry (single source of truth)
   Create shared/integrations/registry.ts

IntegrationId enum:
ga4, gsc, clarity, google_ads, core_web_vitals, crawler, backlinks, kbase, deployer, orchestrator, etc

IntegrationDefinition:
{
id: IntegrationId
name: string
ownerCrew: CrewId
connectRoute: string   // where user fixes it
testRoute?: string
}

This is what fixes “Connect GA4” vs “Configure Popular”:

* GA4.ownerCrew = popular
* So KPI empty states route to Popular setup unless Popular is not hired, etc.

3. CrewStatus service (the one true score)
   Implement on server: server/services/crewStatus.ts

computeCrewStatus({ siteId, crewId, window }) returns:
{
crewId
siteId
score
scoreVersion
status: "ok"|"needs_setup"|"blocked"|"error"
missions: { total, pending, completedThisWeek }
primaryMetric: { id, label, current, baseline, deltaPct, status }
readiness: { missingIntegrations: IntegrationId[], actions: Action[] }
updatedAt
}

Key rule:

* Dashboard and crew pages must NOT compute score locally.
* They both call the same service function (or the same API that uses it).

4. One canonical API used everywhere
   Implement:
   GET /api/sites/:siteId/crew-status
   Returns:
   {
   siteId,
   window,
   crews: CrewStatus[]
   }

Then:

* Dashboard uses this endpoint for the Crew Summary cards (including score)
* Each crew page uses the same endpoint but filters to its crewId (or use /crew-status/:crewId wrapper that calls the same service)
* Settings uses it to show “crew readiness” per site

This eliminates Lookout 51 vs 58 instantly because there is only one source.

5. Theme lineage: apply crew theme at layout level

* Create <CrewPageLayout crewId=...> that reads crewRegistry and sets CSS variables on the page root.
* Dashboard CrewCard reads crewRegistry for border/badge styling.
* Any widget that is “owned by crew” uses CSS vars or theme tokens from crewRegistry.

No component is allowed to define its own crew color.

6. Fix the current Lookout mismatch (likely causes)
   One of these is true:

* Dashboard is using a cached/stale “summaryScore” column updated on a different schedule than the crew page
* Dashboard is using a different time window (e.g., 30d vs 7d)
* Dashboard has a default/fallback score path
* Crew page score is computed client-side from local mission state

Fix:

* Remove dashboard score field usage and replace with CrewStatus.score
* Ensure both pages pass the same window parameter
* Delete any fallback default score constant

7. Guardrails to stop future regressions
   A) Type-enforced consumption

* Define shared types for CrewStatus and use them in both dashboard and crew pages.
* If a page tries to compute its own score, it should be obvious / fail lint rules.

B) Regression test

* Test: Popular/Lookout score consistency

  * fetch /api/sites/:siteId/crew-status
  * fetch crew page model endpoint (if it exists)
  * assert scores match for each crew
    Better: remove crew page endpoint entirely and reuse crew-status.

C) UI snapshot/style checks

* Ensure /crew/popular uses Popular theme CSS vars
* Ensure /crew/lookout uses Lookout theme CSS vars

8. Acceptance criteria

* Crew identity, color, and dependencies are defined once (CrewRegistry + IntegrationRegistry).
* Lookout score is identical on dashboard and Lookout page (58 in both).
* Popular teal shows on dashboard and Popular page.
* KPI empty states always route to the correct owner crew (GA4 → Popular), with “Hire/Configure Popular” when appropriate.
* No page has bespoke score math or hardcoded colors.

Deliverable

* One PR that:

  1. adds CrewRegistry + IntegrationRegistry (shared)
  2. adds server CrewStatus service + /crew-status endpoint
  3. updates dashboard + crew pages to use crew-status scores and registry themes
  4. removes legacy/stale score sources and any fallback score defaults
  5. adds a consistency regression test (dashboard vs crew page score)
