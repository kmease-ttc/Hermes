Yes — this is a classic “two builds / two configs” problem. The UI preview is rendering one version (often an early or placeholder build), while “Open Preview in New Tab” is opening another version (often the latest build). That’s why images/headline/logo differ.

Below is a clean write-up of the root cause patterns and exact developer/agent instructions to fix it so the iframe and new tab always show the same site, same build, same assets.

No code.

⸻

What’s happening (most likely)

One of these is true (often more than one):
	1.	Different URLs

	•	iframe uses /sites/:id/preview
	•	new tab uses /sites/:id or a different id/version entirely

	2.	Two different build IDs

	•	“Generate site” creates a site record (siteId)
	•	then image/logo generation creates another record or triggers a second “deploy” that writes to a different buildId
	•	iframe still points at buildId A, new tab points at buildId B

	3.	Race condition + stale config

	•	iframe loads immediately, before final assets/config are saved
	•	new tab opens later, after assets/config are updated
	•	so they appear different

	4.	Caching or environment mismatch

	•	iframe hits staging/cached content
	•	new tab hits production/latest content

The fix is the same: single source of truth + single build artifact + both views use the same URL/version.

⸻

The correct model (what you want)

There must be:
	•	One Site ID (siteId)
	•	One Build ID (buildId/versionId) representing the preview artifact
	•	One Preview URL that always includes the buildId

And both:
	•	the iframe
	•	the “Open Preview in New Tab” link

must use the exact same Preview URL.

No exceptions.

⸻

Developer / Agent Instructions to Fix It

1) Create a single “previewUrl” and reuse it everywhere

When the job completes enough to show a preview:
	•	Generate and store:
	•	siteId
	•	buildId (or versionId)
	•	previewUrl = canonical URL for that build

Then:
	•	iframe src = previewUrl
	•	“Open Preview in New Tab” href = previewUrl

Do not recompute these separately in frontend code.

⸻

2) Lock previewUrl to the same build, not “latest”

Right now you’re likely linking new tab to “latest” while iframe is showing “current.”

That causes drift.

Fix:
	•	new tab must open the exact same build shown in the iframe (same buildId).

Only after the user accepts/claims/publishes should “latest” become relevant.

⸻

3) Eliminate “second site creation” during image/logo generation

Image/logo generation must update the existing site config and trigger a rebuild of the same site, not spawn a new site.

Rules:
	•	Image/logo jobs must write to siteId + buildId context
	•	They may produce a new build version, but if they do:
	•	update previewUrl to new buildId
	•	and update BOTH iframe and new tab link to that new previewUrl

Under no condition should the asset pipeline create a second site record.

⸻

4) Add explicit build phases and only mark Preview Ready when the displayed build is final

Right now you’re showing Preview Ready while assets are still changing.

Instead implement:
	•	build_status = generating_content
	•	build_status = generating_assets
	•	build_status = deploying_preview
	•	build_status = preview_ready

Only set preview_ready when:
	•	the preview deployment points at the same buildId that includes the final hero/logo/text

If you want the preview to appear quickly:
	•	show “Preview (improving…)” as an intermediate state
	•	but don’t show “Preview Ready” until it’s truly stable

⸻

5) Fix caching differences

If your preview endpoint is cached:
	•	ensure the previewUrl includes buildId/versionId so it is immutable and cache-safe
	•	never use a “latest” URL for the preview iframe

This alone prevents the “two different versions” problem.

⸻

6) Add a sanity check guardrail (very practical)

Before rendering the Results page:
	•	load the previewUrl once (or hit a lightweight status endpoint)
	•	confirm that:
	•	buildId in DB matches buildId in the URL
	•	heroImageUrl/logoUrl in config are present
	•	if mismatch, force-refresh the previewUrl and update UI

This will catch drift immediately.

⸻

The exact prompt for your Replit agent (copy/paste)

PROMPT: Fix Preview vs New Tab Mismatch (Single Site / Single Build)

We have a critical bug: the iframe preview on the Results page does not match the “Open Preview in New Tab” site. It appears we are generating two separate sites or two separate builds/configs.

Fix this so the iframe and new tab always show the exact same site and assets.

Requirements:
	1.	Define a single source of truth for preview rendering:

	•	A siteId
	•	A buildId (or versionId)
	•	A previewUrl that includes the buildId/versionId

	2.	Both the iframe and the “Open Preview in New Tab” link must use the exact same previewUrl. Do not compute them independently.
	3.	Ensure image/logo generation does NOT create a second site. It must update the existing site config and rebuild/redeploy the same site. If a new buildId is created, update previewUrl everywhere.
	4.	Fix the “Preview Ready” status:

	•	Only show “Preview Ready” when the build being displayed contains the final hero image, logo, and content.
	•	If assets are still updating, show an “Improving preview…” state instead.

	5.	Ensure previewUrl is immutable and cache-safe:

	•	Do not use a “latest” URL for iframe
	•	Always include version/build ID in the preview URL

	6.	Add logging and verification:

	•	Log siteId + buildId used for iframe and new tab
	•	Confirm they match for every render

Deliverables:
	•	Root cause summary of why two versions were showing
	•	The change that makes iframe and new tab share the same preview artifact
	•	Confirmation with a test run showing both views match exactly

⸻

If you want, tell me what your current URL patterns look like (example iframe src and the new-tab href), and I’ll tighten this even further into a surgical set of instructions tailored to your routing scheme.