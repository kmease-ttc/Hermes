Nice. Now we turn this into a real product: people can claim their site, set a password, and see the preview behind login.

This is Step 3 – Magic-link signup, auth, and preview page.

You can give the following to your dev.

⸻

Step 3 – Magic-link signup, auth, and preview page

Goal
When a preview site is ready:
	•	We generate a magic-link for that email+site.
	•	User clicks the link → sets a password → gets logged in.
	•	They land on /sites/:id/preview where they can see their preview site and basic plan options.

We’re still stubbing payment and emails (no Stripe yet).

⸻

	1.	DB changes

In /app, extend the DB with:

Table: MagicLink
	•	id (PK)
	•	user_id (FK -> User)
	•	site_id (FK -> Site)
	•	token (string, unique, random)
	•	expires_at (datetime)
	•	used_at (datetime, nullable)
	•	created_at (datetime)

Table: Session (simple cookie-based auth)
	•	id (PK)
	•	user_id (FK -> User)
	•	token (string, unique, random)
	•	created_at (datetime)
	•	expires_at (datetime, nullable)

No need to over-engineer – simple tables are enough.

⸻

	2.	Magic-link generation endpoint (dev-only to start)

In /app:

Add an endpoint to generate magic links manually for now:

POST /api/debug/send-magic-link

Body:

{
  "email": "owner@example.com",
  "siteId": 123
}

Logic:
	1.	Find User by email; if not found, return 400 for now (in practice intake should have created it).
	2.	Find Site by id; verify it exists and is preview_ready.
	3.	Generate a secure random token (e.g., 32–48 char).
	4.	Insert into MagicLink:
	•	user_id = user.id
	•	site_id = site.id
	•	token = generated token
	•	expires_at = now + 7 days
	•	used_at = null
	5.	Log the URL to console:
Magic link: ${APP_PUBLIC_URL}/claim?token=${token}
	6.	Return { ok: true }.

Later the worker can call an internal function to create this link automatically and send a real email; for now, this manual endpoint is enough to test.

⸻

	3.	Claim flow – backend

Add two endpoints:
	1.	GET /api/claim/validate?token=...
	2.	POST /api/claim/complete

a) GET /api/claim/validate

Purpose: front-end calls this on page load to validate the token and prefill info.

Steps:
	•	Look up MagicLink by token.
	•	If not found, expired (expires_at < now), or used_at not null → return 400 and a simple error JSON.
	•	Join with User and Site.
	•	Return:

{
  "ok": true,
  "email": "owner@example.com",
  "siteId": 123,
  "businessName": "Empathy Health Clinic"
}

b) POST /api/claim/complete

Body:

{
  "token": "the-magic-token",
  "password": "PlaintextPasswordFromForm"
}

Steps:
	1.	Fetch MagicLink by token; validate same as above (exists, not expired, not used).
	2.	Fetch User by magicLink.user_id.
	3.	Hash the password (bcrypt or similar) and update:
	•	user.password_hash = hash
	•	user.status = ‘active’
	4.	Attach site to user if not attached yet:
	•	Site.user_id = user.id for magicLink.site_id
	5.	Mark magic link as used:
	•	magicLink.used_at = now()
	6.	Create a Session:
	•	Generate random sessionToken
	•	Insert Session: { user_id: user.id, token: sessionToken, created_at: now, expires_at: now + 30 days }
	7.	Set session cookie on response:
	•	Cookie name: session_token
	•	Value: sessionToken
	•	HTTPOnly, Secure (in prod), SameSite=Lax
	8.	Return:

{
  "ok": true,
  "redirectTo": `/sites/${magicLink.site_id}/preview`
}


⸻

	4.	Auth middleware

In /app, add simple middleware:
	•	Reads session_token cookie.
	•	Looks up Session by token, checks expires_at.
	•	Attaches req.user if valid.
	•	If invalid or missing: responds 401 or redirects (depending on route).

Use for all /sites/* API routes.

⸻

	5.	Frontend routes in /app

Assuming /app has its own React/SPA front-end:

A. Route: /claim
	•	Reads token from URL query.
	•	Calls GET /api/claim/validate?token=....
	•	If invalid → show error (“Link expired or invalid”).
	•	If valid → show:
	•	Email (read-only)
	•	Business name (optional, read-only)
	•	Password + confirm password fields
	•	“Create account & view my preview site” button

On submit:
	•	POST token + password to /api/claim/complete.
	•	On success: redirect to redirectTo from API (e.g. /sites/:id/preview).

B. Route: /sites/:id/preview

This page is behind auth (auth middleware on underlying API).

On mount:
	•	Call GET /api/sites/:id to fetch:

{
  "id": 123,
  "businessName": "...",
  "status": "preview_ready",
  "previewUrl": "https://preview.arclo.dev/site-123"
}

UI:
	•	Header with site name and status “Preview Ready”.
	•	Main section with an iframe or link:
	•	iframe src = previewUrl
	•	If you can’t embed, at least a big “Open preview in new tab” button.
	•	Underneath, very simple “Choose your plan” section:
	•	Starter – $149/mo – [button: Select Starter]
	•	Pro – $299/mo – [button: Select Pro]

For this step, the buttons just call an API that logs selection and returns 200. We’ll wire payment later.

Backend for this:
	•	GET /api/sites/:id
	•	Checks req.user.
	•	Ensures site.user_id === req.user.id.
	•	Returns JSON with id, businessName, status, previewUrl.

Optional:
	•	POST /api/sites/:id/plan with { plan: "starter" | "pro" }
	•	Logs the selection for now.

⸻

	6.	How this will be used end-to-end (now)

For dev testing:
	1.	Run marketing-site, /app, and /worker.
	2.	Submit the “Generate My Website” form on the marketing site.
	3.	Wait for worker to set preview_url and status=preview_ready.
	4.	Call POST /api/debug/send-magic-link with the user email + siteId from DB.
	5.	Copy the logged magic link and paste into browser.
	6.	Go through claim flow: set password → redirected to /sites/:id/preview.
	7.	Confirm that:
	•	Preview loads (iframe/link works with preview_url).
	•	Plan buttons hit the plan API and log correctly.

⸻

	7.	Acceptance criteria for Step 3

	•	MagicLink and Session tables exist and are used.
	•	POST /api/debug/send-magic-link generates and logs a valid link.
	•	Claim page (/claim?token=…) validates tokens, handles expired/used.
	•	POST /api/claim/complete:
	•	sets password
	•	activates user
	•	attaches site.user_id
	•	creates a session + cookie
	•	redirects to /sites/:id/preview
	•	/sites/:id/preview:
	•	requires login
	•	only allows owner of the site
	•	shows the preview URL and basic plan choices.

Once this is working, the next big step will be:
	•	Add simple plan selection + Stripe Checkout,
	•	Then begin wiring in the automation (SERP API, Screaming Frog, blog engine, etc.).