1. Build a generic “External Orchestrator API” in Arclo

Goal
Expose a secure, versioned API that lets any trusted external service:

* submit a structured change plan for a site
* validate it (dry run)
* apply it (write changes)
* publish/redeploy
* retrieve job status + diffs
  No references to any specific orchestrator name in code, routes, headers, logs, or docs.

2. API namespace + versioning

Base path (example):
/api/orchestrator/v1

Keep the “v1” stable and introduce v2 via a new path, not breaking changes.

3. Authentication (service-to-service, no user login)

Implement one of these (pick one and standardize across all endpoints):

Option A (recommended): HMAC signed requests
Required headers:

* X-Client-Id: string (issued by Arclo to the integrator)
* X-Timestamp: unix_ms
* X-Nonce: uuid
* X-Signature: HMAC_SHA256(secret_for_client_id, signature_base)

Signature base string:
METHOD + "\n" + PATH + "\n" + X-Timestamp + "\n" + X-Nonce + "\n" + BODY_SHA256

Rules:

* Reject if timestamp skew > 5 minutes
* Reject reused nonce per client_id within 24h (replay protection)
* BODY_SHA256 is sha256 of raw bytes of the request body (empty string if none)
* Maintain a client registry table storing: client_id, secret_hash, enabled, allowed_sites, rate_limit

Option B: JWT (service account)

* Validate issuer/audience, short expiry, rotate signing keys
* Still include replay protection if possible

4. Core resources

4.1 Sites
Sites are addressed by Arclo’s site ID:

* arclo_site_id: string/uuid

Recommended: enforce client authorization per site:
client_id → allowed_sites[]

4.2 Plans
A “plan” is an immutable JSON document describing intended changes.

Plan identifiers:

* plan_id: uuid generated by the caller (preferred) OR generated by Arclo (acceptable)
* schema_version: “1.0”

Store every plan and its results for audit.

4.3 Jobs
All validate/apply/publish actions run as async jobs.

Job fields (minimum):

* job_id
* arclo_site_id
* plan_id (nullable for publish-only jobs, but recommended always)
* stage: validate|apply|publish
* state: queued|running|succeeded|failed|canceled
* created_at, started_at, finished_at
* result_json (diff summary, changed pages, warnings)
* error_json (safe error details)
* logs (internal) + redacted logs (optional)

5. Plan schema (version 1.0)

Top-level Plan

* plan_id (uuid)
* schema_version: "1.0"
* arclo_site_id
* intent_summary (string)
* risk_level: low|medium|high
* constraints:

  * max_ops (int)
  * max_pages_touched (int)
  * publish_required (bool)
  * allowed_operation_types (optional allowlist)
* operations: [Operation]
* validations: [ValidationRule] (optional)
* rollback:

  * strategy: snapshot | reverse_ops
  * snapshot_id (optional)

Operation (minimum)

* op_id (uuid)
* type (string enum)
* target:

  * page_id OR url_path (require one)
* payload: object (type-specific)
* preconditions:

  * expected_current_hash (optional but recommended)
* acceptance:

  * tests: string[] (optional)

ValidationRule (optional)

* id
* type
* params

6. Endpoints to implement

6.1 Capability discovery
GET /api/orchestrator/v1/sites/{arclo_site_id}/capabilities

Returns:

* supported_schema_versions
* supported_operation_types
* limits (max_ops, max_pages_touched)
* publish_modes supported
* environments supported
* feature_flags

6.2 Validate (dry run)
POST /api/orchestrator/v1/sites/{arclo_site_id}/plans:validate
Body: Plan

Returns immediately:

* job_id
* status_url

Job result must include:

* can_apply: true|false
* per_operation results (ok/warn/error + messages)
* diff_preview (optional but recommended)
* escalated_risk (optional)
* required_manual_approval: true|false (optional)

6.3 Apply (writes changes)
POST /api/orchestrator/v1/sites/{arclo_site_id}/plans:apply
Headers:

* Idempotency-Key: {plan_id} (required)

Body: Plan

Returns:

* job_id
* status_url

Idempotency rules:

* Same Idempotency-Key + same site → return the same job_id and current status
* If same key but different body hash → reject with 409 conflict (prevents accidental misuse)

6.4 Publish (deploy changes)
POST /api/orchestrator/v1/sites/{arclo_site_id}/publish
Headers:

* Idempotency-Key: {plan_id or publish_request_id} (recommended)

Body:

* plan_id (uuid, recommended)
* reason (string)
* mode (optional) full|incremental
* environment (optional) production|staging

Returns:

* job_id
* status_url
* optional preview_url (if staging)

6.5 Job status
GET /api/orchestrator/v1/jobs/{job_id}

Returns:

* stage, state, timestamps
* progress (optional)
* result_json/error_json
* artifacts:

  * snapshot_id
  * diff_summary
  * changed_pages
  * preview_url (optional)
  * deployed_version (commit hash/build id) (optional)

7. Internals: Plan Engine

7.1 Validation pipeline
On validate/apply:

* Validate schema_version
* Validate operation types supported for this site
* Validate limits (max_ops, max_pages_touched)
* Resolve targets (page_id/url_path must exist)
* Run type-specific validation (title length, meta length, JSON-LD parse, etc.)
* Compute a diff preview by applying changes to an in-memory site model

7.2 Preconditions / conflict handling
For each target page/block compute a stable content_hash.
If plan includes expected_current_hash and it doesn’t match:

* mark op as conflict
  Choose a consistent behavior:
* recommended: “skip conflicted ops but apply others”, and report conflicts clearly
  Provide a policy flag per plan (optional):
* on_conflict: fail_plan | skip_op

7.3 Apply transactionality
Before applying:

* Create a snapshot (export site state) and store snapshot_id
  Apply changes in a transaction (or equivalent):
* if any non-recoverable error occurs, rollback to snapshot

7.4 Diff artifact
After apply:

* generate a machine-readable diff artifact:

  * pages_changed: [{page_id, url_path, fields_changed, before_hash, after_hash}]
  * totals: ops_applied, ops_skipped, ops_failed
    Store it in result_json and optionally as a downloadable artifact.

8. Publish pipeline integration

Publishing must:

* run in a worker
* be idempotent if the same Idempotency-Key is reused
* return a deployed_version/build_id
* optionally expose preview_url for staging deploys
* store build logs (internal) and return a redacted summary to callers

9. Webhooks (optional but recommended)

Allow clients to register a webhook URL per client_id:

* webhook_url
* webhook_secret
* enabled

When a job changes state, POST:

* job_id
* arclo_site_id
* plan_id
* stage/state
* result summary
  Sign the webhook:
* X-Webhook-Signature: HMAC_SHA256(webhook_secret, BODY_SHA256)

10. Rate limits + safety

* Per client_id rate limiting (requests/minute + concurrent jobs)
* Per site concurrent job limit (e.g., 1 apply + 1 publish at a time)
* Reject apply/publish if a publish is already running for that site (return 409 with current job_id)
* Add a kill switch: disable client_id immediately

11. Minimal operation types for v1

Start with a safe set:

* UPDATE_TITLE_TAG
* UPDATE_META_DESCRIPTION
* UPDATE_H1
* ADD_SCHEMA_JSONLD
* UPDATE_OPEN_GRAPH
* ADD_INTERNAL_LINKS (bounded, max N links)
* UPDATE_IMAGE_ALT_TEXT

Gate higher-risk ops behind feature flags/manual approval:

* UPDATE_ROBOTS_TXT
* REDIRECT_301
* UPDATE_CANONICAL (bulk)
* DELETE_PAGE
* NAV_STRUCTURE_CHANGE

12. Testing requirements

* Unit tests for signature verification + replay protection
* Contract tests for plan schema validation
* Idempotency tests (same key returns same job)
* Conflict tests (hash mismatch)
* Snapshot rollback tests
* Publish idempotency tests
* Job status + webhook delivery tests (including signature verification)

13. Deliverables for the Arclo team

* OpenAPI spec (YAML/JSON) for the entire /api/orchestrator/v1 surface
* JSON Schema for Plan v1.0
* Example requests/responses for validate/apply/publish
* A small “client usage” doc describing signing + idempotency + job polling/webhooks

This will make Arclo compatible with any external orchestrator without any hard-coded assumptions.
