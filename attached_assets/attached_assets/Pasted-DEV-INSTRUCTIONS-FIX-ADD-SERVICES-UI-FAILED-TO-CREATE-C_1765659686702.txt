DEV INSTRUCTIONS — FIX “ADD SERVICES” UI + “FAILED TO CREATE CHECKOUT SESSION”

Context
User path: Dashboard → Connect My Domain → Setup Domain → Continue → “Yes, I already own one” → lands on “Add Services (Optional)” page.
Issues:
	1.	Add Services page UI looks low-contrast (icons gray, hard to see; unselected state looks broken/off-brand).
	2.	Checkout fails on purchase step: “Failed to create checkout session”.

⸻

A) FIX ADD SERVICES PAGE UI (CONTRAST + ICON VISIBILITY)

Goal
Make unselected + selected service cards look intentional, readable, and consistent with the rest of the product UI.
	1.	Update icon rendering so it’s visible in BOTH states
Problem (from screenshot): icon sits on a gray tile and disappears until selected.
Fix:

	•	Ensure icons are SVGs using currentColor (not hard-coded gray).
	•	Drive icon color from state (selected vs unselected).
	•	Increase tile contrast and add a subtle border.

Implementation requirements
	•	Unselected state:
	•	Icon tile background: slightly lighter than page background (or white with ~5–10% opacity if dark theme)
	•	Icon color: text-slate-600 (or equivalent) with sufficient contrast
	•	Tile border: 1px subtle (e.g., border-white/10 on dark backgrounds)
	•	Selected state:
	•	Icon tile background: use your brand accent with low opacity (e.g., bg-purple-500/15)
	•	Icon color: brand accent (e.g., text-purple-400)

	2.	Service card styling (unselected vs selected)
Unselected card should not look “disabled.”
Add:

	•	border visible on dark background (currently blends in)
	•	clear hover affordance

Recommended Tailwind-ish spec (adapt to your theme tokens)
	•	Card container:
	•	Unselected: bg-white/95 (or bg-slate-900/20 if staying dark), border border-white/10, hover:border-white/20, hover:shadow-md
	•	Selected: border border-purple-400/50, ring-2 ring-purple-400/20, shadow-md
	•	Text:
	•	Title: text-slate-900 (or text-white)
	•	Description: text-slate-600 (or text-white/70) — right now it’s too washed out.

	3.	Radio/selection control alignment + visibility
The circular selector on the left is fine, but make state obvious:

	•	Unselected: thin border with good contrast
	•	Selected: filled dot with brand accent + border accent
	•	Ensure the click target is the entire card (not just the radio)

	4.	“Pills” (Weekly / Popular / 4 posts/month) readability
Currently the “Popular” pill is too faint.

	•	Unselected pills: bg-slate-100 text-slate-700
	•	Accent pill (Popular): bg-purple-600 text-white (or bg-purple-500/20 text-purple-300 if you want subtle, but readable)

Acceptance criteria (UI)
	•	On Add Services page, at 100% zoom, unselected icons are clearly visible without squinting.
	•	Hover state is obvious.
	•	Selected card state is obvious without relying only on the radio.
	•	Looks consistent with the rest of the app’s visual language.

⸻

B) FIX “FAILED TO CREATE CHECKOUT SESSION” (STRIPE/PROVIDER ERROR)

Goal
Clicking “Complete Purchase” must reliably redirect to the hosted checkout page (or open the provider checkout) and return success/cancel properly.
	1.	Identify where checkout session is created
Find the handler invoked by “Complete Purchase” on the Publish/Checkout step (2nd screenshot).
Common patterns:

	•	Next.js route: /api/checkout/create-session
	•	Express route: /api/billing/checkout-session
	•	Server action

	2.	Add structured server-side logging for checkout creation
Right now the user only sees “Failed to create checkout session.” We need the real error.
On the server, log:

	•	request id
	•	user id (or session)
	•	selected plan / add-ons
	•	computed line items / price IDs
	•	environment: NODE_ENV, hostname
	•	the full error message + stack (server logs only)

Also return a safe error to client:
	•	error_code
	•	error_message (friendly)
	•	request_id (so you can correlate)

	3.	Validate required environment variables in the server at startup
Most common cause at launch: missing/incorrect secrets in prod.
Add a boot-time validation (fail fast) for:

	•	STRIPE_SECRET_KEY (or equivalent)
	•	STRIPE_WEBHOOK_SECRET (if used)
	•	PRICE_ID_BASE_PLAN
	•	PRICE_ID_ADDON_WEEKLY_IMPROVEMENTS
	•	PRICE_ID_ADDON_CONTENT_POSTS (etc.)
	•	APP_URL (must match actual origin, e.g., https://arclo.pro)

If any missing:
	•	throw with clear message in logs
	•	surface a friendly “Billing configuration error” to client

	4.	Verify line item construction matches what Stripe expects
On the server, before calling create session:

	•	Ensure every selected item maps to a valid price string (not product id, not null)
	•	Quantity is an integer
	•	Currency consistent

Add a guard:
	•	If any item has missing price id → return 400 with which addon is misconfigured (server logs)

	5.	Confirm success/cancel URLs are correct for production domain
Set:

	•	success_url = ${APP_URL}/billing/success?session_id={CHECKOUT_SESSION_ID}
	•	cancel_url = ${APP_URL}/billing/cancel
If APP_URL is still pointing at a Replit preview domain or localhost, Stripe session creation or redirect can fail or behave strangely.

	6.	Confirm customer identity handling
If you pass customer or customer_email:

	•	Make sure email exists (and is validated)
	•	If using Stripe customer id, ensure it’s not undefined
	•	If user is not logged in, decide:
	•	require login before checkout OR
	•	allow guest checkout with email

	7.	Add idempotency key
Prevent double-click creating multiple sessions:

	•	Use Stripe idempotency key: checkout_${userId}_${cartHash}
	•	Disable button + show loading state on client

	8.	Add a fallback “Billing unavailable” UX
If checkout session creation fails, show:

	•	“We couldn’t start checkout. Please try again.”
	•	“If this keeps happening, email support@arclo.pro with Request ID: XXXXX”
(Do not show raw error details to users.)

Acceptance criteria (Checkout)
	•	From the Publish checkout step, clicking “Complete Purchase” redirects to Stripe checkout successfully.
	•	Returning from Stripe hits success URL and the app reflects active subscription.
	•	Cancel returns to app without breaking the flow.
	•	If failure happens, server logs show the root cause + request id; client shows a friendly message.

⸻

C) QUICK FLOW CHECK (OPTIONAL BUT IMPORTANT)
Right now “Yes, I already own one” sends the user to Add Services. That may be fine, but verify it’s intentional:
	•	If the user is only trying to connect a domain, consider skipping Add Services and letting them connect domain first.
	•	If monetization is the point, keep it—but make the value clear (short summary + “You can skip this” CTA).

If you want, I can write the exact copy + button layout for that page so it feels like a natural step instead of a detour.