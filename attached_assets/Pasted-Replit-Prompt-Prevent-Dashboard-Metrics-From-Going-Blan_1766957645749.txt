Replit Prompt: Prevent Dashboard Metrics From Going Blank — Always Show Last Known Values (Stale-While-Revalidate for Metrics)

Problem
After the last refresh, key dashboard metrics (Conversion Rate, Bounce Rate, Monthly Sessions) disappeared (rendering null/empty). Even if an integration is broken or refresh fails, the dashboard should always display the last known values.

Goal
Implement “last known value” persistence and retrieval so Mission Control/Key Metrics never go blank:

* UI always renders the most recent stored values immediately.
* Refresh attempts update values in the background.
* If refresh fails, keep last known values and show a subtle “stale / last updated” indicator.

Root cause (likely)

* The metrics endpoint is returning null when a worker fails, and the UI overwrites existing state with null.
* Cached integration summary exists, but metrics are not cached/persisted (or we’re not reading from it).
* We’re treating “missing fresh data” as “no data”, instead of “stale data”.

Fix approach
A) Persist metrics snapshots in DB
B) Serve dashboard from latest snapshot
C) Refresh updates snapshot only on success (never overwrite with null)
D) UI merges fresh data into cached, not replace with blanks

Part 1 — Add a metrics snapshot store

1. Create a DB table for last known dashboard metrics per site:
   dashboard_metric_snapshots (
   site_id TEXT PRIMARY KEY,
   captured_at TIMESTAMP NOT NULL,
   metrics_json JSONB NOT NULL
   )

metrics_json should include:

* conversion_rate (number)
* bounce_rate (number)
* leads_form_submits (number)
* sessions_7d / sessions_30d / monthly_sessions (number) (whatever you display)
* plus optional: sourceRunIds, from/to ranges, and per-metric “source” metadata

2. Write snapshots only on successful computation
   When computing dashboard metrics:

* If new values are available, upsert snapshot with those values.
* If values are missing due to refresh failure, DO NOT write nulls.
* Keep existing snapshot intact.

Part 2 — Change Mission Control metrics endpoint to be SWR-safe
3) Implement endpoint:
GET /api/dashboard/metrics?siteId=...

Behavior:

* Return the last snapshot immediately (fast) with:
  { metrics, capturedAt, isStale, lastError? }
* Trigger background refresh if stale (optional), OR provide separate refresh endpoint:
  POST /api/dashboard/metrics/refresh?siteId=...

Important rule:

* If refresh fails, return snapshot + lastError; never return empty metrics just because refresh failed.

Part 3 — Fix UI state handling (do not clobber with null)
4) In the Mission Control page:

* Initialize Key Metrics from cached snapshot response.
* When polling/refreshing:

  * merge new metrics into existing state only if they are non-null/defined
  * if response indicates failure or missing fields, keep existing values
* Display a subtle “Last updated: …” text (you already show updated date; ensure it uses snapshot timestamp)

Part 4 — Map lineage correctly (stop losing values during refresh)
5) If conversion/bounce/monthly sessions come from GA4:

* Ensure the refresh pipeline stores GA4 outputs in the normalized metrics store AND the snapshot builder reads from it.
* If GA4 is unavailable, snapshot remains.

Part 5 — Add safeguards + tests
6) Add regression tests:

* Seed a snapshot with conversion/bounce/sessions.
* Simulate refresh failure (worker timeout).
* Assert API still returns seeded values.
* Assert UI still renders the values.

Acceptance criteria

* Conversion Rate, Bounce Rate, Monthly Sessions never disappear after refresh.
* If integrations are broken, dashboard shows last known values with “stale” indicator.
* Only successful runs update metrics; failures do not wipe them.
* Page loads instantly with cached snapshot, then updates in background when available.

Do this now

1. Add dashboard_metric_snapshots table
2. Update /api/dashboard/metrics to read from snapshots and never return blanks on failure
3. Update refresh logic to only upsert on success
4. Update UI merge logic to not overwrite with null
