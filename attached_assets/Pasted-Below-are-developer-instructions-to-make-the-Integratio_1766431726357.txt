Below are **developer instructions** to make the Integrations summary page actually tell Kevin “where we’re at” — what’s built, what’s configured, what ran, what returned data, what’s blocked, and what needs attention — using the **service catalog + run records** you’ve already added.

---

## Goal

The Integrations summary page must answer, for the selected site:

1. What is **built vs planned**
2. What is **ready vs blocked vs missing config**
3. What has **ever run**, and what **ran recently**
4. For each service: last run time, status, short summary, key metrics, missing outputs
5. A prioritized **“Next actions”** list (what to fix first)

The service cards/detail modal already has expected inputs/outputs; the summary page must become the **operational cockpit**.

---

## 1) Replace “Never ran / blank columns” with real computed states

### Data sources

* `shared/servicesCatalog.ts` (built/planned + expected outputs)
* `service_runs` table (what actually happened)
* `platform_dependencies` endpoint (Bitwarden/DB health)
* `site_settings` (for “configured” or “blocked” signals)

### Add computed per-service state fields to the API response

For each service, return:

* `buildState`: `built | planned`
* `configState`: `ready | blocked | needs_config`
* `runState`: `never_ran | success | failed | partial | stale`
* `lastRun`: `{ id, status, finishedAt, durationMs, summary, metrics, missingOutputsCount } | null`
* `missingOutputs`: string[] (slugs) from `expectedOutputs - actualOutputs`
* `blockingReason`: string | null (ex: “Waiting for Google OAuth approval”, “Base URL missing”, “Secret missing”)

**Important:** “configured/baseUrl” must not be shown unless it matters. Use `configState` + `blockingReason`.

---

## 2) Add a single summary endpoint that returns “dashboard truth”

### Endpoint

`GET /api/sites/:siteId/integrations/summary`

### Response shape

```json
{
  "site": { "id":"...", "domain":"empathyhealthclinic.com" },
  "platform": {
    "bitwarden": { "connected": true, "secretsFound": 14 },
    "database": { "connected": true }
  },
  "rollups": {
    "totalServices": 15,
    "built": 13,
    "planned": 2,
    "ready": 10,
    "blocked": 3,
    "needsConfig": 2,
    "ran24h": 4,
    "neverRan": 9,
    "failed": 1
  },
  "nextActions": [
    { "priority":1, "serviceSlug":"crawl_render_service", "reason":"Never ran", "cta":"Run test" },
    { "priority":2, "serviceSlug":"google_data_connector", "reason":"Blocked: OAuth not connected", "cta":"Connect Google" }
  ],
  "services": [ ...computed services list... ]
}
```

This endpoint is the only thing the Integrations page needs to render correctly.

---

## 3) Implement “Last run per service” correctly (why it’s blank today)

Create a query that returns the latest run per `service_slug` for the selected `site_id`.

### Storage method

`getLatestServiceRunsBySite(siteId)`

Implementation (conceptually):

* filter `service_runs` by `site_id`
* order by `finished_at desc`
* take first per `service_slug`

Return a map:

* key: service_slug
* value: last run record

---

## 4) Show a real top-of-page status panel (this is what Kevin needs)

At top of Integrations page, show:

### A) Platform dependencies strip (already there, but fix Postgres false negative)

* Bitwarden: connected + secrets count
* Database: connected/disconnected (must be truthful)

If DB is shown as disconnected but it isn’t:

* fix the dependency check to run `select 1` and mark connected on success
* don’t rely on a cached boolean

### B) Rollup cards (must be meaningful)

Replace “0 ran in 24h” etc with:

* Built vs Planned
* Ready vs Blocked vs Needs Config
* Ran last 24h
* Never ran
* Failed last run

These rollups come directly from the summary endpoint.

---

## 5) Make the table rows useful (your current table is empty)

### Operational View table columns (final)

* Service
* Status (pill derived from runState/configState)
* Last Run (relative time + exact on hover)
* Summary (from lastRun.summary OR “Never ran” / “Blocked” message)
* Key Metrics (compact pills based on catalog.keyMetrics and lastRun.metrics)
* Missing Outputs (count badge; tooltip shows which slugs)
* Actions (View, Run Test)

### Status pill rules (deterministic)

* Planned → gray “Planned”
* Blocked → yellow “Blocked”
* Needs Config → yellow “Needs config”
* Never ran (built+ready) → gray “Never ran”
* Last run success → green “OK”
* Last run failed → red “Failed”
* Stale (no run in N days) → orange “Stale”

---

## 6) Wire “Run Test” so Kevin can make progress immediately

In each row, add “Run Test” (or reuse existing “Test Connection”):

### Endpoint

`POST /api/services/:slug/test-connection { siteId }`

### Requirement

This must always create a `service_runs` record, even if it’s skipped/blocked.

That will immediately populate Last Run and help Kevin see “what works.”

---

## 7) Add a “Run Daily Diagnosis” button (the missing orchestration layer)

You already have a button mentioned in prior work. Make sure it exists and works:

### Endpoint

`POST /api/diagnostics/run { siteId, mode: "smoke" | "full" }`

* Smoke mode: run 3–5 core services (crawler, vitals, serp, notifications test, audit log)
* Full mode: run everything that is built+ready

This creates:

* `diagnostic_runs` parent record
* child `service_runs` for each service

The rollups “ran in 24h” should be based on these runs.

---

## 8) Add a “Next Actions” panel (this is the nervous system output)

Under rollups, add a prioritized list:

Rules to generate Next Actions (in order):

1. Built+Ready but Never ran → “Run Test”
2. Blocked → show specific blocking reason + CTA
3. Failed last run → “View error” + “Retry”
4. Missing outputs (expected vs actual) → “Fix outputs”
5. Stale runs → “Run now”

Each action item links to the service detail modal.

---

## 9) Fix the site selection behavior (ensure everything is site-scoped)

When the site dropdown changes:

* refetch `/api/sites/:siteId/integrations/summary`
* table and rollups update
* cards view and details view use that same siteId

No mixing global runs with site runs.

---

## 10) Acceptance criteria (what “done” looks like)

For Empathy Health Clinic selected:

* Top shows Built/Planned/Ready/Blocked counts
* Table shows status for every service (never blank)
* At least one actionable CTA per “bad” row (run test / connect / configure)
* Clicking a row opens service details (already works)
* After running “Test Connection” or “Run Daily Diagnosis”, Last Run + Summary + Metrics populate immediately

---

## Quick note on why it’s empty today

Your cards/modal are driven by the catalog, but the summary view is driven by **run records**, and right now either:

* `service_runs` isn’t being written for tests, or
* the query isn’t filtered by `site_id`, or
* the endpoint isn’t returning the computed states.

The summary endpoint + deterministic state computation fixes all of that.

---

If you want, I can also give you a ready-to-paste “service health scoring” formula for the status pill and Next Actions priority, so it’s consistent and doesn’t become subjective as you add more services.
