Build the “Gold Standard Worker Blueprint” for Hermes integrations.

Context:
We have Hermes (an orchestrator) that integrates with many microservice “workers” hosted on Replit. We want every worker to follow a consistent contract so Hermes can reliably run:

* Test Connection
* Smoke Test
* Diagnostics Pipeline (config_loaded → auth_ready → endpoint_built → request_sent → response_type_validated → schema_validated → ui_mapping)

Goal:
Define a reusable, copy/paste-able architecture standard that every worker must implement, and define exactly what Hermes expects and what Bitwarden stores. This blueprint should eliminate “Unexpected token <!DOCTYPE” issues and make failures easy to diagnose.

Deliverables:

1. Worker API Contract (required endpoints + behavior)
2. Worker Auth Contract (API key patterns + error formats)
3. Worker Response Contract (JSON-only, schema versioning, content-type guarantees)
4. Hermes Integration Contract (how Hermes builds URLs, headers, and expected outputs)
5. Bitwarden Secret Contract (standard JSON format + naming conventions)
6. Diagnostics + Observability Requirements (what to log, what to redact, correlation IDs)
7. Reference Implementation Pseudocode (Express/Fastify-style) for a worker
8. Checklist for converting an existing worker to the standard
9. A validation script or “self-test” procedure to confirm a worker is compliant

Constraints / Key Rules:

* Workers are generic microservices (SERP intel, Crawl/Render, Competitive intel, Content QA, Content Decay, etc.)
* Hermes must treat workers uniformly.
* Every /api route must return JSON only; never return HTML for /api (including 404s and errors).
* All errors must be JSON and include a stable error shape (code/message).
* Auth must be consistent across all workers (prefer x-api-key header).
* base_url stored in Bitwarden must include the /api prefix to avoid ambiguity.
* Workers must support a “smoke-test” that returns a predictable output set (even if mocked) so Hermes can validate the integration end-to-end.
* Secrets must never be logged; diagnostics must redact.
* Include correlation ID propagation:

  * Hermes sends X-Request-Id
  * Worker echoes it back and logs it

Worker Required Endpoints:

* GET {base_url}/health

  * Returns JSON with ok:true, service name, version, uptime, and timestamp
* GET {base_url}/smoke-test

  * Runs a minimal end-to-end path and returns JSON with ok:true and a predictable “outputs” object
* POST {base_url}/run

  * Accepts a JSON payload (job request) and returns JSON results
* GET {base_url}/capabilities

  * Returns JSON listing supported “outputs” keys, input parameters, and schema version

Standard Response Shape (Success):
{
"ok": true,
"service": "serp_intel",
"version": "1.0.0",
"schema_version": "2025-12-25",
"request_id": "…",
"data": { ... }
}

Standard Response Shape (Error):
{
"ok": false,
"service": "serp_intel",
"version": "1.0.0",
"schema_version": "2025-12-25",
"request_id": "…",
"error": {
"code": "unauthorized|not_found|invalid_input|upstream_error|rate_limited|timeout|internal",
"message": "human readable",
"details": { ...safe debug... }
}
}

Auth Rules:

* Hermes sends `x-api-key: <api_key>`
* Worker validates against env var WORKER_API_KEY
* If missing/invalid, return 401 JSON error with code “unauthorized”
* Do not redirect; do not render HTML

Bitwarden Secret Standard:
For each worker create one JSON secret:
{
"base_url": "https://<worker-name>--providers2.replit.app/api",
"api_key": "<value>"
}
Name convention:
WORKER_<SERVICE_SLUG>_CONNECTION

Hermes Worker Integration Rules:

* Hermes reads the Bitwarden JSON and validates required keys.
* Hermes uses base_url exactly (no guessing) and appends endpoint paths:

  * /health
  * /smoke-test
  * /capabilities
  * /run
* Hermes always sets:

  * Accept: application/json
  * Content-Type: application/json (for POST)
  * x-api-key: api_key
  * X-Request-Id: generated uuid
* Hermes treats any non-JSON response on /api as a remindable failure and stores:

  * status code
  * content-type
  * body snippet
  * failure_bucket + suggested_fix

Conversion Checklist:

* Ensure worker routes exist under /api
* Add JSON-only 404 for /api
* Add global error handler that returns JSON
* Add auth middleware
* Add /health, /capabilities, /smoke-test, /run
* Add schema_version and service metadata
* Ensure smoke-test returns deterministic output keys
* Verify with curl and Hermes diagnostics

Self-test Procedure:
Provide the exact curl commands to validate a worker:

* health returns JSON 200
* unauthorized response is JSON 401
* smoke-test returns JSON 200 and includes outputs
* capabilities returns expected keys

Also include guidance for “output keys”:

* Each worker declares a list of outputs it can produce, and Hermes uses schema_validated to confirm those exist.

Generate this blueprint as a single cohesive spec that I can use as the standard for all worker services moving forward.
