Got it — this is a **wiring issue**, not a Bitwarden issue anymore. The UI refresh button exists, but it’s not actually triggering a **server-side recheck of Bitwarden + service status**.

Below are **clear, copy-paste instructions for your developer** to properly hook this up so **Refresh actually re-hits Bitwarden, re-evaluates secrets, and updates the Integrations table**.

---

# Developer Instructions: Wire Up “Refresh Integrations” in AI Doctor

## Goal

When the user clicks **Refresh** on the Integrations page:

1. Re-authenticate to Bitwarden using `BWS_ACCESS_TOKEN`
2. Re-fetch available secrets from the assigned Project
3. Re-evaluate each service:

   * Secret exists?
   * Auth wired?
   * Health endpoint reachable?
4. Persist updated status
5. Return updated data to the UI
6. UI re-renders with new statuses

Right now, **step 1 never happens**, so nothing changes.

---

## 1) Backend: Add a real “refresh integrations” endpoint

Create (or confirm existence of) a **server endpoint** that performs a full refresh.

### Endpoint

```
POST /api/integrations/refresh
```

### This endpoint MUST:

* Be side-effectful
* Call Bitwarden live (not cached)
* Recompute service state

---

## 2) Backend logic (required behavior)

### Step A: Authenticate to Bitwarden

Use the existing Bitwarden provider with the current env var:

```
process.env.BWS_ACCESS_TOKEN
```

Fail fast if missing.

---

### Step B: Fetch secrets from Bitwarden

Call:

* **List secrets for the project** the machine account has access to

Result should be something like:

```
[
  "AUDIT_LOG_API_KEY",
  "BACKLINKS_API_KEY",
  "BLOG_WRITER_API_KEY",
  ...
]
```

Do NOT hardcode expected secrets — this endpoint should discover what exists.

---

### Step C: Re-evaluate each registered service

For each service in your `services` table (or config list):

Check:

1. **Secret exists**

   * Match expected secret key name
2. **Auth config**

   * Does service expect API key / bearer / machine token?
3. **Health endpoint**

   * If base URL exists → call `/health`
4. **Auth enforcement**

   * Call endpoint without key → expect 401/403
   * Call with key → expect 200

Store results per service:

```
{
  secretExists: boolean,
  authPass: boolean,
  healthPass: boolean,
  lastCheckedAt: timestamp,
  lastError: string | null
}
```

Persist to DB.

---

### Step D: Return updated inventory

Return the **full service inventory payload** to the client.

---

## 3) Backend: No caching during refresh

This endpoint must:

* Bypass any in-memory or DB cache
* Always call Bitwarden fresh

(You can still cache normal reads — refresh must be authoritative.)

---

## 4) Frontend: Hook the Refresh button to the endpoint

### Current bug

The Refresh button:

* Either does nothing
* Or only refetches local state without triggering backend work

### Fix

On Refresh click:

1. Call:

```
POST /api/integrations/refresh
```

2. While request is in flight:

* Disable button
* Show spinner or “Refreshing…”

3. On success:

* Replace Integrations state with response
* Re-render table/cards

4. On error:

* Show error toast
* Do NOT silently fail

---

## 5) Frontend: Also refresh on page load (important)

On page mount:

* Call the normal `GET /api/integrations`
* But **do not** auto-refresh Bitwarden unless user clicks Refresh

This prevents accidental rate limits but keeps UX correct.

---

## 6) Add explicit logging (temporary but critical)

During development, log:

* Bitwarden auth success/failure
* Number of secrets returned
* Services missing secrets
* Services passing all checks

This will immediately confirm wiring works.

---

## 7) Acceptance tests (must pass)

After implementation:

### Test 1: Missing access

* Remove machine account from Bitwarden project
* Click Refresh
* Result:

  * Secrets = 0
  * UI shows “No secrets accessible”

### Test 2: Grant access

* Re-add machine account to project
* Click Refresh
* Result:

  * Secrets appear
  * Services flip to “Secret ✅”

### Test 3: Rotate token

* Rotate `BWS_ACCESS_TOKEN`
* Update Replit secret
* Restart app
* Click Refresh
* Result:

  * Works immediately

---

## 8) Optional (but strongly recommended UX upgrade)

Add a **Refresh status banner** at the top of Integrations:

> “Last checked: 2 minutes ago · Source: Bitwarden Secrets Manager”

This avoids confusion later.

---

## Why this matters architecturally

This makes Integrations:

* **Event-driven** instead of static
* A real **system-of-record view**
* Safe to extend later (GitHub, Vercel, Cloudflare, etc.)

You’re effectively building a **live control plane**, not a config page.

---

If you want, next we can:

* Add a **“Why is this red?” drill-down modal**
* Add **auto-refresh every N minutes**
* Or promote this into a **Service Health dashboard**

But the above is the minimum required to make **Refresh actually do something real**.
