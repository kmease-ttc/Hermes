Replit Prompt: Fix “Run Diagnostics” Failure in Mission Control + Add Precise Error Reporting + Skip Draper & Deployer

Problem
On Mission Control, clicking “Run Diagnostics” fails with “Fail to Start Diagnostics.” However, Integrations page tests pass. Diagnostics should run the same underlying integrations/workers as Integrations, except it must skip:

* Draper (Paid Ads)
* Deployer (Change Agent)

Goal

1. Make “Run Diagnostics” succeed from Mission Control when integrations are healthy.
2. If it fails, show a precise error explaining exactly what’s missing and which worker needs what update.
3. Ensure Draper + Deployer are excluded from the diagnostics run.

Constraints

* Do not add new features beyond error reporting and routing fixes.
* Diagnostics must use the same single source of truth for integration health as Integrations page.
* This should work in both local dev and deployed environments.

---

Step 1 — Identify the real failure (server-side) and expose it

1. Locate the Mission Control “Run Diagnostics” click handler:

* Find the API endpoint it calls (likely something like):

  * POST /api/diagnostics/start
  * POST /api/run/diagnostics
  * POST /api/run/workers

2. Add structured logging on the server endpoint so we can see the actual root error (not just a generic fail):

* log request payload (redacted)
* log which workers are being targeted
* log auth/headers presence (not values)
* log downstream call failures (status code + response body snippet)

3. Update the endpoint response to return a structured error object:
   {
   ok: false,
   code: "MISSING_CONFIG" | "WORKER_DOWN" | "AUTH_FAILED" | "BAD_RESPONSE" | "INTERNAL_ERROR",
   message: "Human readable",
   details: [
   { worker: "Scotty", issue: "Missing SEO_TECHNICAL_CRAWLER_BASE_URL", fix: "Add config var..." },
   { worker: "Sentinel", issue: "401 Unauthorized", fix: "Update API key / accept Hermes key" }
   ]
   }

Mission Control must display this details list in the UI (toast + expandable panel).

---

Step 2 — Ensure Mission Control and Integrations use the same “runner”
Right now Integrations tests pass, but Mission Control fails. That means they are NOT using the same orchestration path.

Implement a single backend function that both flows call, e.g.:

* runDiagnostics(siteId, options)
  and use it from:
* Integrations “Run Smoke Tests / Run Daily Diagnosis”
* Mission Control “Run Diagnostics”

This runner must:

* discover active services from the same inventory list the Integrations page uses
* filter by connection readiness
* execute “health/smoke” checks first
* only then execute full worker runs

---

Step 3 — Skip Draper and Deployer in diagnostics
Add a skip list at the orchestration layer (server-side), not just UI:

const DIAGNOSTICS_SKIP = ["draper", "deployer"];

When building the diagnostics target list:

* exclude any service/worker whose id/name matches those values
* show them as “Skipped” in diagnostics output so it’s explicit, not silent

---

Step 4 — Fix the common causes of “Fail to Start Diagnostics”
Implement explicit checks before starting:

A) Missing Base URL

* For each worker, confirm its BASE_URL config exists (e.g. SEO_TECHNICAL_CRAWLER_BASE_URL)
* If missing, return:
  code: MISSING_CONFIG
  details: worker + which config key is missing + how to fix

B) Worker not reachable

* Ping worker /health or /api/health with a short timeout (2–3s)
* If non-200, return:
  code: WORKER_DOWN
  include status code and which URL was attempted

C) Auth mismatch between Hermes and worker

* Ensure the auth header Hermes uses matches what the worker expects
* Standardize to:
  Authorization: Bearer <HERMES_TO_WORKER_KEY>
* If worker returns 401/403:
  code: AUTH_FAILED
  details: which worker rejected auth + suggested fix:
  “Update worker to accept Hermes API key via [ENV KEY]”

D) Wrong endpoint path (Integrations vs Diagnostics)

* Some workers may be tested via /health but diagnostics uses /api/run or /api/inspect
* Standardize worker contract:

  * GET /api/health
  * POST /api/run (or /api/diagnostics)
* If a worker doesn’t implement required endpoints:
  code: BAD_RESPONSE
  details must say:
  “Worker missing POST /api/run. Implement this route or update adapter mapping.”

---

Step 5 — Add “Worker Contract Compliance” output (so it tells me what to update)
When a worker fails, generate a “Fix Instructions” block in the UI:

* Worker name
* Missing endpoint or missing env var
* Exact change needed

Example:
Scotty:

* Missing endpoint: POST /api/run
* Fix: Add route handler that accepts {site_id, run_id} and returns AgentInsight payload

Draper:

* Skipped (Paid Ads disabled)

Deployer:

* Skipped (Change Agent disabled)

---

Step 6 — Frontend: show real error and recovery steps
Update Mission Control “Run Diagnostics” UX:

* On failure:

  * Show toast: “Diagnostics failed: <message>”
  * Show expandable panel listing each failing worker and “Fix” text
* On success:

  * Show “Diagnostics started” + run id
  * Link to Integrations operational view for trace

---

Acceptance Criteria

* Clicking “Run Diagnostics” in Mission Control starts a run successfully when services are healthy.
* Draper and Deployer are skipped every time and shown as “Skipped.”
* If any worker fails, Mission Control shows:

  * which worker
  * why it failed (missing config, down, auth, bad endpoint)
  * what to change in that worker to fix it
* Integrations test pass implies Mission Control diagnostics can start (same runner / shared logic).

Deliverables

* One shared server-side diagnostics runner used by both pages
* Structured error responses + detailed UI display
* Worker skip logic for Draper and Deployer
* Worker contract validation and “what to update” messages
