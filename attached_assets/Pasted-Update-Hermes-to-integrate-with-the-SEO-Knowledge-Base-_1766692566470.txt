Update Hermes to integrate with the SEO Knowledge Base worker (SEO_KBASE) using a single canonical Bitwarden secret and header-based auth. Hermes must (1) read KBase config from Bitwarden, (2) call KBase endpoints correctly without double-/api, (3) validate the worker output contract (4 expected outputs), and (4) support write-back to KBase to create a flywheel.

CANONICAL BITWARDEN SECRET
	•	Secret name: SEO_KBASE
	•	Secret JSON (exact):
{
“base_url”: “https://seo-kbase.replit.app/api”,
“api_key”: “<READ_KEY_VALUE>”,
“write_key”: “<WRITE_KEY_VALUE>”
}

Rules:
	•	base_url MUST include “/api” exactly once.
	•	api_key is the KBase READ key (maps to worker env SEO_KBASE_API_KEY).
	•	write_key is the KBase WRITE key (maps to worker env SEO_KBASE_WRITE_KEY).
	•	Keys are NEVER placed in request bodies or query params; headers only.

REQUEST RULES (NO VARIANTS)
	•	For READ endpoints requiring auth, Hermes MUST send:
Header: x-api-key: <api_key>
	•	For WRITE endpoints, Hermes MUST send:
Header: x-api-key: <write_key>

ENDPOINTS & URL CONSTRUCTION
Hermes must treat base_url as the full API prefix and append paths WITHOUT adding another /api.
	•	GET {base_url}/health (no auth)
	•	GET {base_url}/capabilities (no auth)
	•	GET {base_url}/smoke-test (read auth)
	•	POST {base_url}/run (read auth)
	•	POST {base_url}/learnings/upsert (write auth)
	•	POST {base_url}/admin/ingest (write auth, optional)

Implement a safe join function so:
join(base_url, “/run”) -> https://seo-kbase.replit.app/api/run
and never produces /api/api/*.

HEALTH/FINGERPRINT VALIDATION (DIAGNOSTIC)
	•	Hermes should call GET /health during “Test Connection”.
	•	Parse read_key_fingerprint from response.
	•	Compute Hermes fingerprint from the Bitwarden api_key (SHA256, first 8 hex chars).
	•	If mismatched: fail fast with a clear error: “Bitwarden READ key does not match worker deployment.”

SMOKE TEST BEHAVIOR (VALIDATION)
When user clicks “Run Smoke Test”, Hermes must:
	1.	Call GET {base_url}/smoke-test with x-api-key:<api_key>
	2.	Validate the response contains:
outputs.seo_recommendations (array)
outputs.best_practices (array)
outputs.optimization_tips (array)
outputs.reference_docs (array)
If any key missing OR outputs is missing: mark as “0/4 outputs” and show which keys are missing.
If present (even if empty arrays), mark outputs as verified.

RUN BEHAVIOR (READ)
When Hermes runs SEO_KBASE during an orchestrated job:
	•	POST {base_url}/run with header x-api-key:<api_key>
	•	Body must include input fields Hermes already shows for the service:
{
“input”: {
“site_domain”: “”,
“page_urls”: [””, “”],
“target_keywords”: [””, “”],
“check_name”: “<one_of_13_checks_optional>”,
“context”: { …optional… }
}
}
	•	After receiving response, Hermes must map outputs to the service UI:
	•	“SEO Recommendations” <- outputs.seo_recommendations
	•	“Best Practices” <- outputs.best_practices
	•	“Optimization Tips” <- outputs.optimization_tips
	•	“Reference Docs” <- outputs.reference_docs

WRITE-BACK FLYWHEEL (HERMES → KBASE)
After Hermes completes any of the 13 checks (competitive, SERP, keywords, crawl, CWV, GA4, GSC, backlinks, etc.), Hermes should optionally upsert learnings to KBase:
	•	POST {base_url}/learnings/upsert with header x-api-key:<write_key>
	•	Body (Learning payload):
{
“source”: “hermes”,
“check_name”: “<CHECK_NAME>”,
“site_domain”: “”,
“page_url”: “<url_optional>”,
“topic”: “”,
“problem”: “<what’s wrong>”,
“evidence”: [{ “type”: “…”, “value”: “…”, “url”: “…” }],
“recommendation”: “”,
“fix_steps”: [“step 1”, “step 2”],
“labels”: [“technical”, “cwv”, “titles”, “quick_win”],
“confidence”: 0.0-1.0,
“artifacts”: [{ “type”: “…”, “url”: “…” }]
}
	•	Hermes must retry once on transient network failure.
	•	If write-back fails, Hermes must not fail the entire job; it should log “KBase write-back failed” with status + response body.

BITWARDEN FIELD COMPATIBILITY
If Hermes currently only supports {base_url, api_key}:
	•	Add support for optional write_key.
	•	If write_key missing, disable write-back features and show a clear message: “Write-back disabled: missing write_key in Bitwarden SEO_KBASE secret.”

ERROR HANDLING (MUST)
	•	401/403: report “Invalid API key or wrong header; verify Bitwarden key and worker fingerprint.”
	•	404: report “Wrong base_url or double-/api; verify base_url ends with /api and Hermes appends only endpoint paths.”
	•	Non-JSON: report “Worker returned non-JSON; expected JSON API-only worker.”

DELIVERABLE
	•	Hermes reads SEO_KBASE from Bitwarden.
	•	“Test Connection” hits /health and validates fingerprint.
	•	“Run Smoke Test” hits /smoke-test and verifies 4 outputs.
	•	Normal runs call /run and display outputs.
	•	Hermes can write learnings to KBase via /learnings/upsert using write_key.