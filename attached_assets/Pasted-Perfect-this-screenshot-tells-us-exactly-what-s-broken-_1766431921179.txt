Perfect — this screenshot tells us **exactly** what’s broken and what to build next. The good news: the *hard* parts (service catalog, expected inputs/outputs, cards) are already working. What’s missing is the **bridge between real data and the AI layer**.

Below are **very explicit developer instructions** to make the **summary page + “Ask Hermes” actually useful and reliable**.

---

# Developer Instructions: Fix Integrations Summary + Ask Hermes

## What’s broken (plain English)

1. The **summary page** is still mostly static / placeholder

   * It doesn’t clearly tell:

     * what ran
     * what hasn’t run
     * what’s blocked
     * what data actually exists

2. **Ask Hermes fails** with

   > “Sorry, I couldn’t process your question”

   That means:

   * the AI endpoint is either not wired, or
   * it has no structured context to answer from, or
   * it’s throwing and the error is swallowed

Hermes cannot answer *anything* until it is given a **machine-readable operational summary**.

---

## Core Fix: Create ONE authoritative “Operational Summary” object

Everything (dashboard + Ask Hermes) must read from the same source.

### New endpoint (mandatory)

```
GET /api/sites/:siteId/operational-summary
```

This endpoint is **the brainstem** of the app.

---

## 1) What the Operational Summary must contain

Return a single JSON object like this:

```json
{
  "site": {
    "id": "uuid",
    "domain": "empathyhealthclinic.com"
  },

  "platform": {
    "bitwarden": {
      "connected": true,
      "secretsFound": 14
    },
    "database": {
      "connected": true
    }
  },

  "services": [
    {
      "slug": "crawl_render_service",
      "name": "Crawl & Render Service",
      "buildState": "built",
      "configState": "ready",
      "runState": "never_ran",
      "lastRun": null,
      "blockingReason": null,
      "expectedOutputs": ["pages_crawled", "issues_found"],
      "actualOutputs": [],
      "missingOutputs": ["pages_crawled", "issues_found"]
    },
    ...
  ],

  "rollups": {
    "total": 15,
    "built": 13,
    "planned": 2,
    "ready": 9,
    "blocked": 3,
    "neverRan": 10,
    "ranRecently": 2,
    "failed": 1
  },

  "nextActions": [
    {
      "priority": 1,
      "serviceSlug": "google_data_connector",
      "reason": "Blocked: OAuth not completed",
      "action": "Connect Google"
    },
    {
      "priority": 2,
      "serviceSlug": "crawl_render_service",
      "reason": "Built but never ran",
      "action": "Run test"
    }
  ]
}
```

This object must be **100% computed**, not hardcoded.

---

## 2) How to compute the summary (backend logic)

### Data sources to combine

* `serviceCatalog` (expected inputs/outputs, built/planned)
* `service_runs` (what actually ran)
* `platform_dependencies` (Bitwarden, DB)
* `site_settings` (OAuth, config presence)

### Key rules (important)

* **Never ran ≠ failed**
* **Blocked ≠ misconfigured**
* **Planned services should not count as failures**
* A service is:

  * `blocked` if an external dependency is missing (Google approval, OAuth)
  * `ready` if built + config present
  * `never_ran` if ready but no runs exist

---

## 3) Fix the Integrations Summary page UI

### Replace placeholder cards with real data

#### Top status cards should read from `rollups`

Examples:

* “13 built services · 10 never ran”
* “3 blocked (Google OAuth, Ads)”
* “2 services ran in last 24h”

No more “0 ran” unless it’s actually true.

---

### Service table rows must show:

| Column          | Source                               |
| --------------- | ------------------------------------ |
| Status          | derived from runState + configState  |
| Last Run        | `lastRun.finishedAt` or “Never ran”  |
| Summary         | `lastRun.summary` or blocking reason |
| Missing Outputs | length of `missingOutputs`           |
| Action          | contextual CTA                       |

**Never show empty cells.**
If no run → show “Never ran”.

---

## 4) Fix “Ask Hermes” so it actually works

### Root cause of the error you’re seeing

Hermes is being asked a **natural language question**, but:

* it is not given any structured context
* OR the endpoint errors and returns nothing

So the AI literally has nothing to reason from.

---

## 5) Implement Ask Hermes correctly (this is critical)

### Endpoint

```
POST /api/hermes/ask
```

### Request body

```json
{
  "siteId": "uuid",
  "question": "Hermes, what is the current operational state..."
}
```

### Server-side flow (mandatory)

1. Fetch `operational-summary` for the site
2. Inject it into the system prompt
3. THEN call the LLM

---

### System prompt (copy/paste for dev)

```
You are Hermes, the operational reasoning engine for an SEO diagnostics platform.

You must answer strictly based on the provided operational summary.
Do not assume data that is not present.
If something has never run, say so explicitly.
If something is blocked, explain why.

Operational Summary:
{{JSON.stringify(summary, null, 2)}}
```

### User prompt

Just pass the user’s question verbatim.

---

### Failure handling (important)

If:

* summary fetch fails
* LLM errors
* invalid response

Return a **clear error message** like:

> “Hermes cannot answer yet because no operational data exists for this site.”

Do **not** return a generic “try again”.

---

## 6) Make Ask Hermes useful even today (before everything runs)

Hermes should still be able to answer:

> “Most services are built but have never run yet. Google data is blocked pending OAuth approval. No crawl data exists yet, so technical SEO health is unknown.”

That’s already hugely valuable.

---

## 7) Acceptance Criteria (what “done” looks like)

### Summary page

* Clearly shows:

  * what’s built
  * what’s blocked
  * what’s never run
* No blank values
* Every service row has a clear status and next action

### Ask Hermes

* No more “couldn’t process”
* Answer references:

  * specific services
  * run states
  * blocking reasons
* Answers change when runs are executed

Example good answer:

> “For Empathy Health Clinic, 13 services are built. 10 have never run yet. The Crawl & Render and Web Vitals services have not been executed, so technical health is unknown. Google Analytics data is blocked pending OAuth approval. The next best action is to run a diagnostic crawl.”

---

## 8) Why this matters (big picture)

Once this is in place:

* You no longer need to remember what you built
* The UI becomes a **truth mirror**
* Hermes becomes actually intelligent (because it has facts)
* You can scale from 1 site → many sites without losing your mind

---

If you want, next I can:

* write the **exact SQL/Drizzle query** to compute latest runs per service
* generate the **Hermes system prompt + schema** as code
* or help you design the **Daily Diagnosis workflow** so running once fills most of the dashboard immediately

Just tell me which one.
