Goal
Replace “Contact us” on the /login screen with a full “Create account” workflow that supports self-serve signup, email verification, and secure login sessions, without breaking the existing marketing pages or dashboard routing.

User Experience

1. Login page (/login)

* Keep existing UI.
* Replace “Need an account? Contact us” with:

  * “Need an account? Create one”
  * Link to /signup

2. Signup page (/signup)
   Fields:

* Email
* Password
* Confirm password
* (Optional) Name (nice to have)
  Actions:
* Primary: Create account
* Secondary: “Already have an account? Sign in” → /login
  Validation:
* Email format
* Password policy (min length 10 recommended)
* Passwords match
  Errors:
* Email already in use
* Weak password
  Success:
* Show “Check your email to verify your account” (do not auto-login until verified, unless you explicitly want instant access)

3. Email verification page (/verify-email)

* Reads token from URL: /verify-email?token=...
* If valid: marks user verified, shows success, button to /login
* If invalid/expired: shows error and “Resend verification email”

4. Resend verification (/resend-verification)

* Field: email
* Sends a new verification email if the account exists and is not verified
* Always return a generic success message to prevent account enumeration

5. Forgot password (/forgot-password) + Reset (/reset-password?token=...)

* Optional but strongly recommended since you’re enabling self-serve accounts
* Same token approach, expiration, and generic responses

Backend Requirements

1. Database schema (Drizzle)
   Create/extend users table with:

* id (uuid)
* email (unique, indexed)
* password_hash
* verified_at (nullable timestamp)
* created_at
* updated_at

Create verification_tokens table:

* id (uuid)
* user_id (fk)
* token_hash (store hash, not raw token)
* expires_at
* created_at

Create password_reset_tokens table (if implementing reset):

* id (uuid)
* user_id (fk)
* token_hash
* expires_at
* created_at

2. API Endpoints
   POST /api/auth/signup

* Body: { email, password, name? }
* Creates user (unverified), stores password_hash
* Generates verification token (random), stores token_hash + expiry
* Sends verification email with link to /verify-email?token=RAW_TOKEN
* Returns: 200 with generic message

POST /api/auth/login

* Body: { email, password }
* Verify password
* If not verified: return 403 + “Please verify your email” (and include a “resend” option in UI)
* If verified: create session (cookie), return success

POST /api/auth/logout

* Clears session cookie

GET /api/auth/me

* Returns current user (if session valid)

POST /api/auth/verify-email

* Body: { token }
* Hash token, find matching token_hash not expired
* Set users.verified_at = now
* Delete token row
* Return success

POST /api/auth/resend-verification

* Body: { email }
* If user exists + not verified, generate new token + send email
* Return generic success regardless

(Optional)
POST /api/auth/forgot-password
POST /api/auth/reset-password

3. Security & Best Practices

* Store token hashes (sha256) not raw tokens
* Store password hashes using bcrypt/argon2 (bcrypt ok)
* Rate limit auth endpoints (per IP + per email)
* Do not reveal whether an email exists on resend/forgot flows
* Set cookies: HttpOnly, Secure (in prod), SameSite=Lax
* Ensure CORS is not overly permissive
* Ensure the marketing pages do not require auth; dashboard routes do

Routing / App Architecture

* Keep marketing routes public (/, /pricing, etc.)
* Make dashboard routes protected:

  * If user not logged in → redirect to /login
* Ensure the SPA catch-all does not swallow API routes:

  * API routes must be registered before app.get("*")

Email Delivery

* Use your existing email system if present; otherwise add:

  * SMTP (SendGrid/Mailgun/etc.)
* Secrets needed:

  * EMAIL_FROM
  * EMAIL_PROVIDER_API_KEY or SMTP creds
  * APP_BASE_URL (production) and DEV_BASE_URL

Links in emails must use the correct base URL per environment:

* DEV: https://<repl>.replit.dev
* PROD: [https://traffic-doctor-ai--providers2.replit.app](https://traffic-doctor-ai--providers2.replit.app)

UI Changes Needed

* Login page: replace “Contact us” with “Create account” link to /signup
* Add Signup page component
* Add Verify Email page component
* Add Resend Verification page or inline action on login error

Acceptance Criteria

* A new user can create an account on /signup
* They receive a verification email within 1 minute
* Clicking verify link sets the account as verified
* User can then log in and access dashboard routes
* Unverified users cannot log in (unless you choose auto-login)
* Existing marketing pages remain accessible without auth
* No preview/iframe-specific issues introduced (do not set restrictive X-Frame-Options/CSP that breaks Replit preview)

Replit Implementation Prompt (for your dev agent)
Implement a full self-serve account creation workflow:

* Add /signup, /verify-email, /resend-verification (and optional forgot/reset)
* Add DB migrations (drizzle) for users + verification tokens
* Add API endpoints listed above under /api/auth/*
* Add secure session handling using HttpOnly cookies
* Update /login UI: replace “Contact us” with “Create one” linking to /signup
* Protect dashboard routes behind auth and redirect unauthenticated users to /login
* Add email verification sending with environment-aware base URL
* Include basic rate limiting and generic responses to prevent user enumeration
* Provide a small README section describing required secrets and how to test locally + in prod

If you tell me which auth/session approach you’re currently using (e.g., express-session, JWT cookies, Lucia, NextAuth-like, custom), I can tailor the exact endpoint + middleware code to match what’s already in Hermes.
