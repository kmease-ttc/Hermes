Yep — we’re down to the **Bitwarden connector** now (the refresh wiring is working). Here are **developer instructions** to fix “Bitwarden not connected” in a way that’s fast to debug and hard to break later.

---

# Dev Instructions: Fix “Bitwarden not connected” (Hermes / Integrations)

## Goal

When user clicks **Refresh**, Hermes should:

1. validate Bitwarden config (token, org/project)
2. successfully list secrets
3. return a clear status: **Connected + N secrets found** (or an actionable error: 401 vs 403 vs missing config)

Right now it’s returning “not connected,” which means the connector call is failing or returning zero access.

---

## 1) Add a dedicated Bitwarden status endpoint (single source of truth)

### Endpoint

`GET /api/integrations/bitwarden/status`

### Response contract

Return:

```json
{
  "connected": false,
  "reason": "MISSING_TOKEN | UNAUTHORIZED | FORBIDDEN | PROJECT_NOT_FOUND | ZERO_SECRETS | API_ERROR",
  "httpStatus": 401,
  "projectId": "…or null",
  "secretsFound": 0,
  "lastError": "short message safe for UI"
}
```

This makes it obvious what’s wrong without guessing.

---

## 2) Ensure the connector is using the correct Bitwarden Secrets Manager method

### Required env vars (Hermes)

* `BWS_ACCESS_TOKEN` (already in Replit)
* `BWS_PROJECT_ID` (add this as a Replit **secret** or config)
* Optional (only if needed by your setup):

  * `BWS_BASE_URL` (self-hosted / EU region only)

**Important:** Don’t “infer” project from token. Always specify project explicitly.

---

## 3) Implement the connector as: “list secrets for project”

In the Bitwarden connector module:

### Pseudocode steps

1. If no `BWS_ACCESS_TOKEN` → `connected=false, reason=MISSING_TOKEN`
2. Call Bitwarden Secrets Manager API:

   * “List secrets in project” (or list secrets accessible to machine account and filter by project)
3. Interpret responses:

   * 401 → `UNAUTHORIZED` (bad/expired token)
   * 403 → `FORBIDDEN` (token valid, machine account lacks project access)
   * 404 → `PROJECT_NOT_FOUND` (wrong project id)
   * 200 but `[]` → `ZERO_SECRETS` (project empty or machine account can’t see anything)

Return `connected=true` only if:

* the list call succeeds AND
* it returns at least 1 secret (or allow 0 but treat as “connected-empty”)

I recommend:

* `connected=true` if the API call succeeds
* plus a separate warning state if `secretsFound === 0`

---

## 4) Update the Refresh flow to use the new status endpoint first

In `POST /api/integrations/refresh`:

1. Call `bitwarden/status`

2. If status is not connected:

   * Return refresh payload with:

     * `bitwarden.connected=false`
     * `bitwarden.reason=…`
     * Set all “Secret” checks to unknown/false with a note: “Bitwarden unavailable”
   * Do **not** run service auth tests (because you can’t fetch keys)

3. If Bitwarden is connected:

   * Fetch secrets list
   * Evaluate each service’s `expectedSecretKey`
   * Continue with /health + auth tests

---

## 5) UI: Show the *real reason* (not just “not connected”)

Replace the banner message with something like:

* **Token missing**: “Bitwarden token not set in server env.”
* **Unauthorized (401)**: “Bitwarden token invalid/expired. Rotate token.”
* **Forbidden (403)**: “Machine account doesn’t have access to this project.”
* **Project not found (404)**: “Project ID is wrong or project doesn’t exist.”
* **Connected but empty**: “Connected, but no secrets found in this project.”

This will save you hours.

---

## 6) Required config change (most likely missing right now)

Given your screenshot shows `BWS_ACCESS_TOKEN` exists, the most common remaining failure is:

* Hermes doesn’t know the **Project ID**, so it’s querying nothing or filtering wrong

### Action

Add to Replit Secrets/Config:

* `BWS_PROJECT_ID = <your Bitwarden Secrets Manager project id>`

Then redeploy/restart and click Refresh.

---

## 7) One-time “smoke test” route for debugging (temporary)

Add:
`GET /api/integrations/bitwarden/debug`

Return:

* whether token present (true/false)
* project id present (true/false)
* response status code from list call
* secrets count
* first 5 secret keys (names only, never values)

Remove or admin-gate later.

---

## 8) Acceptance tests

1. With correct project access:

* Banner: “Bitwarden connected · N secrets found”
* Services show Secret ✅ where expected

2. Remove machine account from project:

* Banner shows Forbidden / access issue
* No secret checks run

3. Rotate token without updating Replit:

* Banner shows Unauthorized 401

---

## What you can do right now (no dev needed)

Most likely you just need to **add `BWS_PROJECT_ID`** in Hermes Replit secrets/config and restart. If you tell me where you’re storing the project id today (if anywhere), I’ll tell you the exact place to put it and the exact expected variable name so the code picks it up.
